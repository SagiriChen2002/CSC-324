---
title: "COVID-19_project"
author: "Haobo Chen"
output: html_document
date: "2024-02-04"
editor_options: 
  markdown: 
    wrap: 72
---

Academic Honesty Name(s) of all authors: Haobo Chen Assignment name:
Individual Project Assignment due date: TBD Written/online sources used:
None Help obtained (Acknowledgments): None Add the statement: We confirm
that the above list of sources is complete AND that we have not talked
to anyone else about the solution to this problem.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(tidyr)
library(magrittr)
library(ggplot2)
library(qrcode)
library(lattice)
library(wordcloud2)
library(shiny)
library(leaflet)
library(maps)
library(sf)
library(shinydashboard)
library(lubridate)
```

## Building an R Shiny app

```{r}
# Load and prepare the US states geographical data
us_states <- st_read("US_geographic_dataset/cb_2018_us_state_20m.shp")
us_states <- st_transform(us_states, 4326)

# Load the education data
education_data <- read_csv("database/Education.csv")
covid_data <- read_csv("database/us-states.csv")

# Aggregate the education data to state level
# Assuming 'State' is the state name or code that matches the shapefile
# and you're interested in "Percent of adults with less than a high school diploma"
education_state_level <- education_data %>%
  group_by(State) %>%
   summarise(
        Education_Less_HS = mean(`Percent of adults with less than a high school diploma`, na.rm = TRUE),
        High_School_Diploma_Only = mean(`Percent of adults with a high school diploma only`, na.rm = TRUE),
        Some_College = mean(`Percent of adults completing some college or associate's degree`, na.rm = TRUE),
        Bachelors_Or_Higher = mean(`Percent of adults with a bachelor's degree or higher`, na.rm = TRUE)
      )

# Aggregate the COVID data to state level
# Assuming 'state' is the state name or code that matches the shapefile
covid_state_level <- covid_data %>%
  group_by(state) %>%
  summarise(Cases = sum(cases), Deaths = sum(deaths))

# Match state abbreviations in shapefile with those in education data
merged_data <- us_states %>%
  left_join(education_state_level, by = c("STUSPS" = "State"))

merged_data <- us_states %>%
  left_join(covid_state_level, by = c("STUSPS" = "state"))



# Create a Shiny app object
ui <- dashboardPage(
  dashboardHeader(title = "COVID and Education Level Analysis"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Map", tabName = "map", icon = icon("globe")),
      menuItem("Line Graph", tabName = "line_graph", icon = icon("line-chart"))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(tabName = "map",
              fluidRow(
                column(width = 3,
                      # Add a menu input for the user to select the education level
                      selectInput("educationAttribute", "Choose Education Level:",
                                  choices = c("Percent of adults with less than a high school diploma" = "Percent of adults with less than a high school diploma",
                                              "Percent of adults with a high school diploma only" = "High school diploma only",
                                              "Percent of adults with some college or associate's degree" = "Some college or associate's degree",
                                              "Percent of adults with a bachelor's degree or higher" = "Bachelor's degree or higher")),
                      selectInput("covidAttribute", "Choose COVID-19 Attribute:",
                                  choices = c("Cases" = "Cases",
                                                 "Deaths" = "Deaths"))
                ),
                column(width = 9,
                       leafletOutput("mapOutput"), # Changed 'map' to 'mapOutput' to avoid potential conflicts
                       br(), # Adds a line break between maps
                       leafletOutput("covidMapOutput")
                       
                ),
              
      )
    )
  )
)
)

```

## Server function

```{r}
library(shiny)
library(shinydashboard)
library(leaflet)
library(sf)
library(dplyr)
library(readr) # For read_csv


# Step 1: Create a state name to abbreviation mapping

# Assuming us_states is preloaded and transformed outside the server function for simplicity in this example
# us_states <- st_read("path_to_shapefile.shp")
# us_states <- st_transform(us_states, 4326)

server <- function(input, output, session) {
  # Reactive expression for loading and preparing education data
  educationData <- reactive({
    education_data <- read_csv("database/Education.csv") %>%
      group_by(State) %>%
      summarise(Education_Level = mean(get(input$educationAttribute), na.rm = TRUE),
      Education_Less_HS = mean(`Percent of adults with less than a high school diploma`, na.rm = TRUE),
        High_School_Diploma_Only = mean(`Percent of adults with a high school diploma only`, na.rm = TRUE),
        Some_College = mean(`Percent of adults completing some college or associate's degree`, na.rm = TRUE),
        Bachelors_Or_Higher = mean(`Percent of adults with a bachelor's degree or higher`, na.rm = TRUE)
      )
    
    merged_data <- st_read("US_geographic_dataset/cb_2018_us_state_20m.shp") %>%
      st_transform(., 4326) %>%
      left_join(education_data, by = c("STUSPS" = "State"))
    
    return(merged_data)
  })

  # Reactive expression for loading and preparing COVID data for 2023-03-23
covidData <- reactive({
  covid_data <- read_csv("database/us-states-output.csv") %>%
    mutate(Date = as.Date(date, format = "%Y-%m-%d")) %>%
    filter(Date == as.Date("2023-03-23")) %>%
      group_by(state) %>%
      summarise(COVID_Level = sum(get(input$covidAttribute)), Cases = sum(Cases), Deaths = sum(Deaths))

  merged_covid_data <- st_read("US_geographic_dataset/cb_2018_us_state_20m.shp") %>%
    st_transform(., 4326) %>%
    left_join(covid_data, by = c("STUSPS" = "state"))
  
  return(merged_covid_data)
})


  
  # Output for the map, which depends on the reactive education data
  output$mapOutput <- renderLeaflet({
    # Call the reactive expression and store its result
    data <- educationData() # Correctly calling the reactive expression
    
    leaflet(data = data) %>%
    fitBounds(-125, 24.396308, -66.934570, 49.384358) %>% # Fit the map to the US bounds
      addProviderTiles(providers$CartoDB.Positron) %>%
      addPolygons(fillColor = ~colorQuantile("YlOrRd", Education_Level)(Education_Level),
                  fillOpacity = 0.7,
                  weight = 1,
                  color = "white",
                  dashArray = "3",
                  highlightOptions = highlightOptions(weight = 3,
                                                       color = "#666",
                                                       dashArray = "",
                                                       fillOpacity = 0.7,
                                                       bringToFront = TRUE),
                  popup = ~paste(NAME, "<br>",
                       "Less than HS Diploma: ", round(Education_Less_HS, 2), "%<br>",
                       "High School Diploma Only: ", round(High_School_Diploma_Only, 2), "%<br>",
                       "Some College: ", round(Some_College, 2), "%<br>",
                       "Bachelor's or Higher: ", round(Bachelors_Or_Higher, 2), "%")
      ) %>%
      addLegend("bottomright", pal = colorQuantile("YlOrRd", data$Education_Level), values = ~Education_Level,
                title = input$educationAttribute,
                opacity = 0.7)
  })



output$covidMapOutput <- renderLeaflet({
  data <- covidData() # Use the reactive COVID data
 # Generate popup content dynamically based on selected attribute
  
  
  leaflet(data = data) %>%
    fitBounds(-125, 24.396308, -66.934570, 49.384358) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(fillColor = ~colorQuantile("YlOrRd", COVID_Level)(COVID_Level),
                fillOpacity = 0.7,
                weight = 1,
                color = "white",
                dashArray = "3",
                highlightOptions = highlightOptions(weight = 3,
                                                     color = "#666",
                                                     dashArray = "",
                                                     fillOpacity = 0.7,
                                                     bringToFront = TRUE),
                 popup = ~paste(NAME, "<br>",
                            "Cases" = formatC(as.integer(Cases), big.mark=","),
                            "Deaths" = formatC(as.integer(Deaths), big.mark=","))
                ) %>%
    addLegend("bottomright",  pal = colorQuantile("YlOrRd", data$COVID_Level), values = ~COVID_Level,
              title = input$covidAttribute,
              opacity = 0.7)
})
#addLegend("bottomright", pal = colorQuantile("YlOrRd", data$Education_Level), values = ~Education_Level,
                #title = input$educationAttribute,
                #opacity = 0.7)
  # No need for observeEvent if the map automatically updates with input$apply due to reactive dependencies
}

# Run the app
shinyApp(ui, server)
```
